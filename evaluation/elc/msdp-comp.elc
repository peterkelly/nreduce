range from to =
(if (<= from to)
    (cons from (range (+ from 1) to))
    nil)

sum lst =
(if lst
    (+ (head lst) (sum (tail lst)))
    0)

mkrequest n ms     = (++ (numtostring n) (++ " " (numtostring ms)))

parseresponse resp = (stringtonum (tail resp))

main args =
(if (< (len args) 4)
    "Usage: msdp-comp.elc host port size stages compms\n"

(letrec host = (item 0 args)
        port = (stringtonum (item 1 args))
        size = (stringtonum (item 2 args))
        stages = (stringtonum (item 3 args))
        compms = (stringtonum (item 4 args))
        callservice n =
          (parseresponse (connect host port (mkrequest n compms)))
        loop total stages =
          (if (> stages 0)
              (letrec
                 res = (map (!x.callservice (+ total x)) (range 1 size))
                 total2 = (callservice (sum res))
               in
                 (loop total2 (- stages 1)))
              total)
        result = (loop 0 stages)
 in     (++ (numtostring result) "\nEND\n")))
