inputstr =
"AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHAAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHH"

times n lst =
(if (== n 0)
  nil
  (append lst (times (- n 1) lst)))

range from to =
(if (<= from to)
    (cons from (range (+ from 1) to))
    nil)

sum lst =
(if lst
    (+ (head lst) (sum (tail lst)))
    0)

foldr f base lst =
(if lst
    (f (head lst) (foldr f base (tail lst)))
    base)

main args =
(if (< (len args) 4)
    "Usage: msdp-tr.elc host port nitems nstages inpsize\n"

(letrec host = (item 0 args)
        port = (stringtonum (item 1 args))
        nitems = (stringtonum (item 2 args))
        nstages = (stringtonum (item 3 args))
        inpsize = (stringtonum (item 4 args))


        input = (times inpsize inputstr)

        process data index =
          (connect host
                   port
                   (++ "process\n" (++ (numtostring index) (++ " " data))))

        combine results =
          (connect host
                   port
                   (++ "combine\n" (foldr ++ "" (map (!x.++ " " x) results))))


        loop value nstages =
          (if (> nstages 0)
              (loop (combine (map (process value) (range 1 nitems)))
                    (- nstages 1))
              value)

        result = (loop input nstages)

 in     (++ result "\nEND\n")))
