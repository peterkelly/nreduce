printcol n         = (++ (numtostring n) " ")

printrow row       = (foldr ++ "\n" (map printcol row))

printmatrix matrix = (foldr ++ "" (map printrow matrix))

creatematrix size  = (map (!x.(range x (+ x (- size 1))))
                          (range 0 (- size 1)))

mkrequest n ms     = (++ (numtostring n) (++ " " (numtostring ms)))

parseresponse resp = (stringtonum (tail resp))

main args =
(if (< (len args) 4)
    "Usage: nested.elc host port size compms\n"
(letrec host = (item 0 args)
        port = (stringtonum (item 1 args))
        size = (stringtonum (item 2 args))
        compms = (stringtonum (item 3 args))
        callservice n =
          (parseresponse (connect host port (mkrequest n compms)))
        input = (creatematrix size)
        output = (map (!row.map callservice row) input)
 in     (++ (printmatrix output) "END\n")))
