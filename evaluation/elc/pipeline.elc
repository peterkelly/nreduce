range from to =
(if (<= from to)
    (cons from (range (+ from 1) to))
    nil)

foldr f base lst =
(if lst
    (f (head lst) (foldr f base (tail lst)))
    base)

addnewline str =
(++ str "\n")

printstrings strings =
(foldr ++ "" (map addnewline strings))

// Usage: nitems comp services...

main args =
(if (< (len args) 3)
  "Usage: pipeline.elc <nitems> <comp> services...\n"
(letrec nitems = (stringtonum (item 0 args))
        comp = (stringtonum (item 1 args))
        services = (skip 2 args)

        callservice host x =
          (stringtonum (tail (connect host
                                      1234
                                      (++ (numtostring (+ x 1))
                                          (++ " " (numtostring comp))))))

        f lst x = (if lst
                      (callservice (head lst) (f (tail lst) x))
                      x)

        res = (map numtostring (map (f services) (range 1 nitems)))

 in     (printstrings res)))
